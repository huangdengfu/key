<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>船型开关筛选器</title>
  <link rel="icon" href="LOGO.png" type="image/png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #1a2a6c, #2c3e50);
      color: #333;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      padding: 30px 20px;
      color: #fff;
      margin-bottom: 30px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 15px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    }

    header h1 {
      font-size: 2.8rem;
      margin-bottom: 10px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, .3);
    }

    header p {
      font-size: 1.2rem;
      max-width: 900px;
      margin: 0 auto;
      color: #e0e0e0;
      line-height: 1.6;
    }

    .content-wrapper {
      display: flex;
      gap: 25px;
      flex-wrap: wrap;
    }

    .filters {
      flex: 1;
      min-width: 320px;
      background: #fff;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .2);
    }

    .results {
      flex: 3;
      min-width: 300px;
      background: #fff;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .2);
    }

    .section-title {
      font-size: 1.5rem;
      color: #2c3e50;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #3498db;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .filter-group {
      margin-bottom: 22px;
    }

    .filter-group h3 {
      margin-bottom: 12px;
      color: #2980b9;
      font-size: 1.05rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-options {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .filter-option {
      background: #f8f9fa;
      border: 1px solid #ddd;
      padding: 10px 15px;
      border-radius: 30px;
      cursor: pointer;
      transition: all .3s ease;
      font-size: .9rem;
      user-select: none;
    }

    .filter-option:hover {
      background: #e3f2fd;
      border-color: #3498db;
    }

    .filter-option.active {
      background: #3498db;
      color: #fff;
      border-color: #3498db;
    }

    .search-box {
      position: relative;
      margin: 25px 0;
    }

    .search-box input {
      width: 100%;
      padding: 14px 20px 14px 45px;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 1rem;
      transition: all .3s ease;
    }

    .search-box input:focus {
      border-color: #3498db;
      outline: none;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, .2);
    }

    .search-box i {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      color: #777;
    }

    .stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 12px 0;
      border-bottom: 1px solid #eee;
      gap: 12px;
      flex-wrap: wrap;
    }

    .result-count {
      font-size: 1.05rem;
      color: #2c3e50;
    }

    .sorting select {
      padding: 8px 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background: #fff;
      font-size: 0.95rem;
      width: 180px;
    }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .product-card {
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      transition: transform .3s ease, box-shadow .3s ease;
      background: #fff;
      box-shadow: 0 4px 8px rgba(0, 0, 0, .05);
      display: flex;
      flex-direction: column;
    }

    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, .1);
    }

    /* —— 图片区域：去背景、方图友好 —— */
    .product-image {
      width: 100%;
      aspect-ratio: 1 / 1;
      /* 保持 1:1 方形区域 */
      background: #f7f7f7;
      /* 有图时去底图：纯白背景 */
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }

    .product-image img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      /* 适配方图与非方图 */
      padding: 8px;
      /* 适度留白，避免贴边 */
      transition: transform .3s ease;
      cursor: zoom-in;
      /* 表示可放大 */
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .product-image img.loaded {
      opacity: 1;
    }

    .product-card:hover .product-image img {
      transform: scale(1.03);
    }

    .product-info {
      padding: 20px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .product-series {
      display: inline-block;
      background: #3498db;
      color: #fff;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: .9rem;
      margin-bottom: 10px;
    }

    .product-title {
      font-size: 1.1rem;
      margin-bottom: 10px;
      color: #2c3e50;
      min-height: 60px;
      line-height: 1.35;
      flex: 1;
    }

    .product-specs {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .spec {
      background: #f8f9fa;
      padding: 6px 10px;
      border-radius: 5px;
      font-size: .9rem;
    }

    .spec.size-value {
      background-color: #e3f2fd;
      font-weight: 600;
    }

    .product-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .product-link {
      flex: 1;
      text-align: center;
      background: #2ecc71;
      color: #fff;
      padding: 12px;
      border-radius: 5px;
      text-decoration: none;
      font-weight: 600;
      transition: all .3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .product-link:hover {
      background: #27ae60;
    }

    .copy-link {
      flex: 1;
      text-align: center;
      background: #3498db;
      color: #fff;
      padding: 12px;
      border-radius: 5px;
      text-decoration: none;
      font-weight: 600;
      transition: all .3s ease;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .copy-link:hover {
      background: #2980b9;
    }

    .no-results {
      text-align: center;
      padding: 40px;
      grid-column: 1 / -1;
    }

    .no-results i {
      font-size: 4rem;
      color: #e74c3c;
      margin-bottom: 20px;
    }

    .no-results h3 {
      font-size: 1.6rem;
      margin-bottom: 10px;
      color: #2c3e50;
    }

    .reset-btn {
      width: 100%;
      justify-content: center;
      background: #e74c3c;
      color: #fff;
      margin-top: 16px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 14px;
      border: none;
      border-radius: 8px;
      font-size: .95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all .2s ease;
    }

    .reset-btn:hover {
      background: #c0392b;
    }

    .footer {
      text-align: center;
      color: #fff;
      padding: 30px;
      margin-top: 40px;
      font-size: .9rem;
      opacity: .8;
    }

    hr.soft {
      border: none;
      border-top: 1px solid #e5e7eb;
      margin: 16px 0;
    }

    /* 尺寸匹配提示 */
    .size-match {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-left: 8px;
    }

    .size-match.exact {
      background-color: #2ecc71;
      color: white;
    }

    .size-match.close {
      background-color: #f39c12;
      color: white;
    }

    /* 复制成功提示 */
    .copy-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(46, 204, 113, 0.9);
      color: white;
      padding: 15px 25px;
      border-radius: 5px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1000;
      transform: translateX(120%);
      transition: transform 0.3s ease-out;
    }

    .copy-notification.show {
      transform: translateX(0);
    }

    html {
      scroll-behavior: smooth;
    }

    /* 回到顶部悬浮按钮 */
    #back-to-top {
      position: fixed;
      right: 22px;
      bottom: 22px;
      width: 44px;
      height: 44px;
      border: none;
      border-radius: 999px;
      background: #3498db;
      color: #fff;
      display: none;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 20px rgba(0, 0, 0, .15);
      cursor: pointer;
      transition: opacity .25s ease, transform .25s ease, filter .15s ease;
      opacity: 0;
      transform: translateY(10px);
      z-index: 50;
    }

    #back-to-top.show {
      display: flex;
      opacity: 1;
      transform: translateY(0);
    }

    #back-to-top:hover {
      filter: brightness(.95);
    }

    #back-to-top i {
      font-size: 18px;
    }

    @media (max-width: 768px) {
      .content-wrapper {
        flex-direction: column;
      }

      .products-grid {
        grid-template-columns: 1fr;
      }

      header h1 {
        font-size: 2.2rem;
      }

      .sorting select {
        width: 160px;
      }

      #back-to-top {
        right: 16px;
        bottom: 16px;
        width: 40px;
        height: 40px;
      }

      .product-actions {
        flex-direction: column;
      }

      .product-title {
        min-height: auto;
      }
    }

    /* —— 图片放大查看（Lightbox） —— */
    .lightbox {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 24px;
      background: rgba(0, 0, 0, 0);
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity .25s ease, background .25s ease;
    }

    .lightbox.show {
      background: rgba(0, 0, 0, .7);
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }

    .lightbox-content {
      position: relative;
      max-width: 92vw;
      max-height: 92vh;
    }

    .lightbox-img {
      max-width: 92vw;
      max-height: 92vh;
      object-fit: contain;
      border-radius: 8px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
      background: #fff;
      transform: scale(.96);
      opacity: 0;
      transition: transform .25s ease, opacity .25s ease;
    }

    .lightbox.show .lightbox-img {
      transform: scale(1);
      opacity: 1;
    }

    .lightbox-close {
      position: absolute;
      top: -14px;
      right: -14px;
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 50%;
      background: rgba(0, 0, 0, .75);
      color: #fff;
      font-size: 18px;
      cursor: pointer;
      display: grid;
      place-items: center;
    }

    .lightbox-close:hover {
      background: rgba(0, 0, 0, .85);
    }

    /* 图片加载占位符 */
    .image-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f0f0f0;
    }

    .image-placeholder i {
      font-size: 2rem;
      color: #ccc;
    }

    /* 减少动画（系统偏好） */
    @media (prefers-reduced-motion: reduce) {

      .lightbox,
      .lightbox-img {
        transition: none !important;
      }
    }

    /* 优化提示面板 */
    .optimization-tips {
      background: #fff8e1;
      border-left: 4px solid #ffc107;
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
    }

    .optimization-tips h3 {
      color: #ff9800;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-toggle-on"></i> 船型开关筛选器</h1>
      <p>用于快速查询是否有满足需求的船型开关 | Telesky旗舰店</p>
    </header>

    <!-- <div class="optimization-tips">
      <h3><i class="fas fa-bolt"></i> 图片加载优化提示</h3>
      <p>如果图片加载缓慢，建议：</p>
      <ul>
        <li>压缩图片文件大小（使用工具如TinyPNG）</li>
        <li>将图片转换为WebP格式（减少30%以上体积）</li>
        <li>使用CDN加速图片加载</li>
        <li>确保图片尺寸适当（建议不超过500x500px）</li>
      </ul>
    </div> -->

    <div class="content-wrapper">
      <div class="filters">
        <h2 class="section-title"><i class="fas fa-filter"></i> 筛选条件</h2>

        <div class="filter-group">
          <h3><i class="fas fa-list"></i> 产品系列</h3>
          <div class="filter-options" id="series-options"></div>
        </div>

        <div class="filter-group">
          <h3><i class="fas fa-microchip"></i> 引脚数量</h3>
          <div class="filter-options" id="pins-options"></div>
        </div>

        <div class="filter-group">
          <h3><i class="fas fa-sliders-h"></i> 档位数量</h3>
          <div class="filter-options" id="positions-options"></div>
        </div>

        <div class="filter-group">
          <h3><i class="fas fa-lightbulb"></i> 指示灯</h3>
          <div class="filter-options" id="light-options"></div>
        </div>

        <div class="filter-group">
          <h3><i class="fas fa-ruler-combined"></i> 尺寸筛选 (长度/直径)</h3>
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="size-input" placeholder="输入尺寸(mm)，如：24" />
          </div>
          <div style="margin-top: 8px; font-size: 0.85rem; color: #666;">
            提示：输入长度或直径尺寸(mm)，系统将智能匹配最接近的规格
          </div>
        </div>

        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="search-input" placeholder="输入关键词（关键词查找）..." />
        </div>

        <button class="reset-btn" id="reset-filters">
          <i class="fas fa-sync-alt"></i> 重置所有筛选条件
        </button>
      </div>

      <div class="results">
        <div class="stats">
          <div class="result-count">找到 <span id="result-count">0</span> 个产品</div>
          <div class="sorting">
            <select id="sort-by">
              <option value="default">默认排序</option>
              <option value="pins">引脚数从少到多</option>
              <option value="pinsDesc">引脚数从多到少</option>
              <option value="positions">档位数从少到多</option>
              <option value="positionsDesc">档位数从多到少</option>
              <option value="sizeAsc">尺寸从小到大</option>
              <option value="sizeDesc">尺寸从大到小</option>
            </select>
          </div>
        </div>
        <div class="products-grid" id="products-container"></div>
      </div>
    </div>

    <div class="footer">
      <p>© 2025 船型开关筛选器 | Telesky 旗舰店 https://telesky.tmall.com</p>
    </div>
  </div>

  <!-- 回到顶部按钮 -->
  <button id="back-to-top" aria-label="回到顶部" title="回到顶部">
    <i class="fas fa-arrow-up"></i>
  </button>

  <!-- 复制成功提示 -->
  <div class="copy-notification" id="copy-notification">
    <i class="fas fa-check-circle"></i>
    <span>链接已复制到剪贴板！</span>
  </div>

  <!-- 图片放大查看（Lightbox） -->
  <div class="lightbox" id="lightbox" aria-hidden="true">
    <div class="lightbox-content" role="dialog" aria-label="图片预览">
      <button class="lightbox-close" id="lightbox-close" aria-label="关闭预览">&times;</button>
      <img id="lightbox-img" class="lightbox-img" alt="产品大图">
    </div>
  </div>

  <script>
    // —— 回到顶部 —— //
    const backTopBtn = document.getElementById('back-to-top');
    const updateBackTop = () => {
      const y = window.scrollY || document.documentElement.scrollTop;
      backTopBtn.classList.toggle('show', y > 400);
    };
    window.addEventListener('scroll', updateBackTop);
    backTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
    updateBackTop();

    // ===== 1) 数据来源（仅本地/远程文件；去除内置示例） =====
    const LS_KEY = "rockerSwitchProducts";
    let products = [];
    let filters = { series: "all", pins: "all", positions: "all", light: "all", search: "", size: "" };

    const productsContainer = document.getElementById("products-container");
    const resultCount = document.getElementById("result-count");
    const searchInput = document.getElementById("search-input");
    const resetBtn = document.getElementById("reset-filters");
    const sortSelect = document.getElementById("sort-by");
    const sizeInput = document.getElementById("size-input");
    const copyNotification = document.getElementById("copy-notification");

    // 可自动探测的本地数据路径（CSV/JSON）
    const LOCAL_SOURCES = ['./products.csv', './data/products.csv', './products.json', './data/products.json'];

    // ===== 2) 工具函数 =====
    function showStatus(msg, type = "info") { console.log(`[${type.toUpperCase()}] ${msg}`); }
    function hideStatus() { /* 无 UI 提示位时无需处理 */ }

    function normalizeRecord(r) {
      const t = v => (v == null ? "" : String(v).trim());
      let obj = {
        spec: t(r.spec),
        series: t(r.series),
        pins: t(r.pins),
        positions: t(r.positions),
        skuLink: t(r.skuLink),
        light: t(r.light),
        size: t(r.size),
        imageId: t(r.imageId),
        image: t(r.image || r.imageUrl),           // 允许直接提供图片URL
        fullImage: t(r.fullImage || r.fullImageUrl) // 允许提供大图URL（未提供则回退到 image）
      };

      const toIntStr = v => { const n = parseInt(v, 10); return Number.isFinite(n) ? String(n) : ""; };
      obj.pins = toIntStr(obj.pins);
      obj.positions = toIntStr(obj.positions);

      const lamp = obj.light.replace(/\s/g, "").toLowerCase();
      if (["lamp", "led", "light", "withlight", "带灯", "有灯"].includes(lamp)) obj.light = "带灯";
      else if (["nolamp", "withoutlight", "无灯", "不带灯"].includes(lamp)) obj.light = "无灯";

      return obj;
    }

    function validateRecord(o) {
      if (!/^\d+$/.test(o.pins)) return "pins 必须是整数";
      if (!/^\d+$/.test(o.positions)) return "positions 必须是整数";
      if (!/^https?:\/\//i.test(o.skuLink)) return "skuLink 需要 http/https 链接";
      if (!["带灯", "无灯"].includes(o.light)) return "light 仅支持：带灯/无灯";
      return null;
    }

    const toUnifiedList = x => (Array.isArray(x) ? x : (Array.isArray(x?.items) ? x.items : [])).map(normalizeRecord);

    function setProducts(newList, mode = "replace") {
      products = (mode === "replace") ? [...newList] : [...products, ...newList];
      const seen = new Set();
      products = products.filter(p => { const key = [p.spec, p.series, p.pins, p.positions, p.light].join("|"); if (seen.has(key)) return false; seen.add(key); return true; });
      localStorage.setItem(LS_KEY, JSON.stringify({ ts: Date.now(), items: products }));
      buildAllFacets(products);
      applyFilters();
      showStatus(`已加载数据 ${products.length} 条。`, "success");
    }

    function parseCsv(text) {
      if (window.Papa) { const out = Papa.parse(text, { header: true, skipEmptyLines: true }); return out.data; }
      const [head, ...rows] = text.split(/\r?\n/).filter(Boolean);
      const headers = head.split(",").map(s => s.trim());
      return rows.map(line => { const cols = line.split(","); const o = {}; headers.forEach((h, i) => o[h] = cols[i] ?? ""); return o; });
    }

    function ingest(list, mode = "replace") {
      const arr = toUnifiedList(list);
      const ok = [], bad = [];
      arr.forEach((o, i) => {
        const err = validateRecord(o);
        if (err) { console.warn(`记录 ${i} 验证失败: ${err}`, o); bad.push({ i, err }); }
        else { ok.push(o); }
      });
      if (!ok.length) { showStatus(`没有可导入的有效记录。`, "error"); return; }
      setProducts(ok, mode);
    }

    // —— 动态筛选项 —— //
    function sortSeries(a, b) {
      const ma = /^KCD(\d+)/i.exec(a), mb = /^KCD(\d+)/i.exec(b);
      if (ma && mb) return (+ma[1]) - (+mb[1]);
      if (ma) return -1; if (mb) return 1;
      return a.localeCompare(b, 'zh');
    }
    const sortNumericAsc = (a, b) => (+a) - (+b);

    function buildOptions(container, key, values) {
      const current = filters[key];
      if (!values.includes(current)) filters[key] = 'all';
      const chips = [`<div class="filter-option ${filters[key] === 'all' ? 'active' : ''}" data-filter="${key}" data-value="all">全部${key === 'series' ? '系列' : ''}</div>`]
        .concat(values.map(v => `<div class="filter-option ${v === filters[key] ? 'active' : ''}" data-filter="${key}" data-value="${v}">${v}${key === 'pins' ? '脚' : ''}${key === 'positions' ? '档' : ''}</div>`));
      container.innerHTML = chips.join('');
    }

    function buildAllFacets(list) {
      const s = new Set(), p = new Set(), po = new Set(), l = new Set();
      list.forEach(x => { if (x.series) s.add(x.series.trim()); if (x.pins) p.add(String(x.pins)); if (x.positions) po.add(String(x.positions)); if (x.light) l.add(x.light.trim()); });
      buildOptions(document.getElementById('series-options'), 'series', Array.from(s).sort(sortSeries));
      buildOptions(document.getElementById('pins-options'), 'pins', Array.from(p).sort(sortNumericAsc));
      buildOptions(document.getElementById('positions-options'), 'positions', Array.from(po).sort(sortNumericAsc));
      buildOptions(document.getElementById('light-options'), 'light', Array.from(l).sort((a, b) => a.localeCompare(b, 'zh')));
    }

    // —— 尺寸解析与匹配 —— //
    function parseSize(sizeStr) {
      if (!sizeStr) return null;
      const matchDimensions = sizeStr.match(/(\d+(?:\.\d+)?)\s*[*x×]\s*(\d+(?:\.\d+)?)/i);
      if (matchDimensions) { return { length: parseFloat(matchDimensions[1]), width: parseFloat(matchDimensions[2]), isCircular: false }; }
      const matchSingle = sizeStr.match(/(\d+(?:\.\d+)?)\s*mm?/i);
      if (matchSingle) { return { length: parseFloat(matchSingle[1]), width: null, isCircular: true }; }
      const matchEnd = sizeStr.match(/(\d+(?:\.\d+)?)\s*mm?$/i);
      if (matchEnd) { return { length: parseFloat(matchEnd[1]), width: null, isCircular: true }; }
      return null;
    }
    function calculateSizeDifference(targetSize, productSize) { if (!targetSize || !productSize) return Infinity; return Math.abs(targetSize - productSize.length); }

    // —— 复制链接 —— //
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        copyNotification.classList.add('show');
        setTimeout(() => copyNotification.classList.remove('show'), 2000);
      }).catch(err => { console.error('复制失败:', err); alert('复制链接失败，请手动复制'); });
    }

    // —— 从本地文件加载 —— //
    async function loadFromLocalFiles() {
      hideStatus();
      for (const path of LOCAL_SOURCES) {
        try {
          const res = await fetch(path + (path.includes('?') ? '&' : '?') + 't=' + Date.now(), { cache: 'no-store' });
          if (!res.ok) continue;
          const ct = (res.headers.get('content-type') || '').toLowerCase();
          if (ct.includes('json') || path.toLowerCase().endsWith('.json')) {
            const json = await res.json(); ingest(json, 'replace'); showStatus(`已从本地JSON文件加载：${path}`, 'success'); return true;
          } else if (ct.includes('csv') || path.toLowerCase().endsWith('.csv')) {
            const text = await res.text(); const rows = parseCsv(text); ingest(rows, 'replace'); showStatus(`已从本地CSV文件加载：${path}`, 'success'); return true;
          }
        } catch (e) { console.error(`加载 ${path} 失败:`, e); }
      }
      showStatus('未找到本地数据文件。', 'warn');
      buildAllFacets([]); applyFilters();
      return false;
    }

    // ===== 3) 事件绑定（委托支持动态按钮） =====
    function setupEventListeners() {
      document.querySelector('.filters').addEventListener('click', (e) => {
        const btn = e.target.closest('.filter-option');
        if (!btn || !btn.dataset.filter) return;
        const group = btn.closest('.filter-options');
        group.querySelectorAll('.filter-option').forEach(el => el.classList.remove('active'));
        btn.classList.add('active');
        filters[btn.dataset.filter] = btn.dataset.value;
        applyFilters();
      });

      document.getElementById('search-input').addEventListener('input', function () { filters.search = this.value.toLowerCase(); applyFilters(); });

      document.getElementById('size-input').addEventListener('input', function () { this.value = this.value.replace(/[^\d.]/g, ''); filters.size = this.value; applyFilters(); });

      document.getElementById('reset-filters').addEventListener('click', () => {
        filters = { series: 'all', pins: 'all', positions: 'all', light: 'all', search: '', size: '' };
        buildAllFacets(products);
        document.getElementById('search-input').value = '';
        document.getElementById('size-input').value = '';
        document.getElementById('sort-by').value = 'default';
        applyFilters();
      });

      document.getElementById('sort-by').addEventListener('change', applyFilters);

      // 复制链接（委托）
      document.getElementById('products-container').addEventListener('click', function (e) {
        if (e.target.closest('.copy-link')) {
          const card = e.target.closest('.product-card');
          const link = card.querySelector('.product-link').href;
          copyToClipboard(link);
        }
      });

      // 图片点击放大（委托）
      document.getElementById('products-container').addEventListener('click', function (e) {
        const img = e.target.closest('img[data-full]');
        if (!img) return;
        openLightbox(img.getAttribute('data-full'));
      });

      // 关闭大图
      document.getElementById('lightbox-close').addEventListener('click', closeLightbox);
      document.getElementById('lightbox').addEventListener('click', (e) => { if (e.target.id === 'lightbox') closeLightbox(); });
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeLightbox(); });
    }

    // ===== 4) 过滤 / 渲染 =====
    function colorForSeries(s) {
      const fixed = { KCD1: '#3498db', KCD3: '#2ecc71', KCD4: '#e74c3c', KCD11: '#f39c12', '圆形': '#9b59b6', '全圆': '#1abc9c' };
      if (fixed[s]) return fixed[s];
      let h = 0; for (let i = 0; i < s.length; i++) h = (h * 31 + s.charCodeAt(i)) >>> 0;
      return `hsl(${h % 360} 60% 45%)`;
    }

    function applyFilters() {
      let list = [...products];
      if (filters.series !== 'all') list = list.filter(p => p.series === filters.series);
      if (filters.pins !== 'all') list = list.filter(p => p.pins === filters.pins);
      if (filters.positions !== 'all') list = list.filter(p => p.positions === filters.positions);
      if (filters.light !== 'all') list = list.filter(p => p.light === filters.light);
      if (filters.search) list = list.filter(p => (p.spec || '').toLowerCase().includes(filters.search));

      const targetSize = parseFloat(filters.size);
      let sizeDiffMap = new Map();
      let filteredList = [];
      let minDiff = Infinity;

      if (!isNaN(targetSize)) {
        list.forEach(p => {
          const parsedSize = parseSize(p.size || '');
          if (parsedSize) {
            const diff = calculateSizeDifference(targetSize, parsedSize);
            sizeDiffMap.set(p, diff);
            if (diff < minDiff) minDiff = diff;
          } else {
            sizeDiffMap.set(p, Infinity);
          }
        });
        if (minDiff === 0) filteredList = list.filter(p => sizeDiffMap.get(p) === 0);
        else if (minDiff <= 5) filteredList = list.filter(p => sizeDiffMap.get(p) === minDiff);
        else filteredList = [];
      } else {
        filteredList = [...list];
      }

      const sortBy = document.getElementById('sort-by').value;
      if (sortBy === 'pins') filteredList.sort((a, b) => (+a.pins) - (+b.pins));
      else if (sortBy === 'pinsDesc') filteredList.sort((a, b) => (+b.pins) - (+a.pins));
      else if (sortBy === 'positions') filteredList.sort((a, b) => (+a.positions) - (+b.positions));
      else if (sortBy === 'positionsDesc') filteredList.sort((a, b) => (+b.positions) - (+a.positions));
      else if (sortBy === 'sizeAsc') filteredList.sort((a, b) => { const A = parseSize(a.size || ''), B = parseSize(b.size || ''); if (A && B) return A.length - B.length; if (A) return -1; if (B) return 1; return 0; });
      else if (sortBy === 'sizeDesc') filteredList.sort((a, b) => { const A = parseSize(a.size || ''), B = parseSize(b.size || ''); if (A && B) return B.length - A.length; if (A) return -1; if (B) return 1; return 0; });

      renderProducts(filteredList, sizeDiffMap, targetSize);
    }

    function resolveImage(p) {
      // 优先使用 image / fullImage 字段；否则使用 imageId 拼接到本地目录
      const img = p.image || (p.imageId ? `imagef/${p.imageId}.png` : 'LOGO.png');
      const full = p.fullImage || img; // 未提供单独大图地址时，使用同一地址
      return { img, full };
    }

    function renderProducts(list, sizeDiffMap, targetSize) {
      resultCount.textContent = list.length;
      productsContainer.innerHTML = '';

      if (!isNaN(targetSize) && list.length === 0) {
        productsContainer.innerHTML = `
              <div class="no-results">
                <i class="fas fa-ruler"></i>
                <h3>没有找到匹配尺寸的产品</h3>
                <p>未找到尺寸为 ${targetSize}mm 或接近尺寸 (±5mm) 的产品</p>
                <p>请尝试调整尺寸筛选条件</p>
              </div>`;
        return;
      }

      if (list.length === 0) {
        productsContainer.innerHTML = `
              <div class="no-results">
                <i class="fas fa-search"></i>
                <h3>没有找到匹配的产品</h3>
                <p>请尝试调整筛选条件或搜索关键词</p>
              </div>`;
        return;
      }

      list.forEach(p => {
        const card = document.createElement('div');
        card.className = 'product-card';
        const bg = colorForSeries(p.series || '');
        const parsedSize = parseSize(p.size || '');

        let sizeMatchHtml = '';
        if (!isNaN(targetSize)) {
          const diff = sizeDiffMap.get(p);
          if (diff !== undefined && diff !== Infinity) {
            if (diff === 0) sizeMatchHtml = `<span class="size-match exact">完全匹配 (${targetSize}mm)</span>`;
            else if (diff <= 5) sizeMatchHtml = `<span class="size-match close">接近匹配 (差${diff}mm)</span>`;
          }
        }

        let sizeValue = '未提供';
        if (parsedSize) sizeValue = parsedSize.isCircular ? `直径: ${parsedSize.length}mm` : `长: ${parsedSize.length}mm × 宽: ${parsedSize.width}mm`;

        const { img, full } = resolveImage(p);

        card.innerHTML = `
              <div class="product-image">
                <div class="image-placeholder"><i class="fas fa-spinner fa-spin"></i></div>
                <img src="${img}" data-full="${full}" alt="${p.spec}" loading="lazy"
                     onload="this.classList.add('loaded'); this.previousElementSibling.style.display='none';" 
                     onerror="this.onerror=null; this.src='LOGO.png'; this.previousElementSibling.style.display='none';" />
              </div>
              <div class="product-info">
                <div class="product-series" style="background:${bg}">${p.series || '未分组'} 系列 ${sizeMatchHtml}</div>
                <h3 class="product-title">${p.spec || ''}</h3>
                <div class="product-specs">
                  <div class="spec"><i class="fas fa-microchip"></i> ${p.pins}脚</div>
                  <div class="spec"><i class="fas fa-sliders-h"></i> ${p.positions}档</div>
                  <div class="spec"><i class="fas fa-lightbulb"></i> ${p.light}</div>
                  <div class="spec size-value"><i class="fas fa-ruler"></i> ${sizeValue}</div>
                </div>
                <div class="product-actions">
                  <a href="${p.skuLink}" target="_blank" class="product-link">
                    <i class="fas fa-external-link-alt"></i> 查看详情
                  </a>
                  <button class="copy-link" data-link="${p.skuLink}">
                    <i class="fas fa-copy"></i> 复制链接
                  </button>
                </div>
              </div>`;
        productsContainer.appendChild(card);
      });
    }

    // —— Lightbox 逻辑 —— //
    function openLightbox(src) {
      const lb = document.getElementById('lightbox');
      const img = document.getElementById('lightbox-img');
      img.src = src;
      lb.classList.add('show');
      lb.setAttribute('aria-hidden', 'false');
    }
    function closeLightbox() {
      const lb = document.getElementById('lightbox');
      const img = document.getElementById('lightbox-img');
      lb.classList.remove('show');
      lb.setAttribute('aria-hidden', 'true');
      // 等待过渡结束后再清理src，避免关闭动画时图片瞬时消失
      setTimeout(() => { img.src = ''; }, 260);
    }

    // ===== 5) 初始化 =====
    function init() {
      setupEventListeners();
      loadFromLocalFiles(); // 不再使用内置示例，纯读取本地/远程数据
    }
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>

</html>
